<!DOCTYPE HTML>
<html style="height:100%">
<head>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta charset="UTF-8">
  <!-- Angular Material style sheet -->
  <link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.4/angular-material.min.css">
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.1.0/dist/leaflet.css">
  <style>
    .leaflet-pane {
      z-index:100;
    }

    .searchBarSuggestions li {
      border-bottom: 1px solid #ccc;
      height: auto;
      padding-top: 4px;
      padding-bottom: 4px;
      white-space: normal;
    }

    .searchBarSuggestions li:last-child {
      border-bottom-width: 0;
    }
    .searchBarSuggestions .item-aliases {
      font-size:12px;
      color:rgba(1, 1, 1, 0.54);
    }
    .searchBarSuggestions .item-title,
    .searchBarSuggestions .item-aliases {
      display: block;
      line-height: 2;
    }

    md-backdrop {
      z-index: 300 !important;
    }

    .about {
      position: fixed;
      right: 0;
      bottom: 16px;
      background: rgba(255, 255, 255, 0.7);
      font-size:11px;
      z-index:800;
      padding:0px 5px;
    }

    .about a {
      color:rgb(0, 120, 168);
      text-decoration:none;
    }

    .about a:hover {
      text-decoration:underline;
    }
  </style>
<title>Useful Aalto Map</title>
  <script src="https://unpkg.com/leaflet@1.1.0/dist/leaflet.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.6.5/angular.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ui-leaflet/2.0.0/ui-leaflet.js"></script>
</head>
<body ng-cloak style="height:100%; margin:0" ng-app="usefulAaltoMap">

  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/4.17.4/lodash.min.js"></script>

  <!-- Angular Material dependencies -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-simple-logger/0.1.7/angular-simple-logger.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular-animate.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular-aria.min.js"></script>
  <script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.5/angular-messages.min.js"></script>

  <!-- Angular Material Library -->
  <script src="https://ajax.googleapis.com/ajax/libs/angular_material/1.1.4/angular-material.min.js"></script>

  <!-- Client-side routing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/angular-ui-router/0.4.2/angular-ui-router.min.js"></script>

  <script src="app.js"></script>
  <script src="main/main.js"></script>
  <script src="sidenav/sidenav.js"></script>

  <script>

    angular.module('usefulAaltoMap')
    .service('mapService', function(leafletData, utils, $timeout) {
      var mapS = {};

      mapS.map = {
        enable: ['click'],
        center: {
          lat: 60.1871,
          lng: 24.8261,
          zoom: 17
        },
        paths: {},
        watchOptions: {
          individual: { type: 'watch' },
          type: 'watchCollection'
        }
      }

      leafletData.getMap().then(function(map) {
        mapS.leafletMap = map;
        $timeout(function() {
          // refresh map to update after loading
          map.invalidateSize();
        })
      })

      mapS.zoomOnObject = function(obj) {
        if (obj == null) return;
        // When an object is selected from search.
        // TODO: add more types
        //mapS.openSidenav(obj);
        if (obj.outline != null) {
          mapS.leafletMap.fitBounds(obj.outline);
          mapS.highlightObject(obj);
        } else if (obj.latlon != null) {
          //$scope.leafletMap.fitBounds([[obj.latlon[0]-.0007, obj.latlon[1]-.0007],[obj.latlon[0]+.0007, obj.latlon[1]+.0007]]);
          mapS.leafletMap.flyTo(obj.latlon, 18);
          //$scope.leafletMap.panTo(obj.latlon);
          mapS.highlightObject(obj);
        } else if (obj.parents && obj.parents.length >= 1) {
          var outline = utils.coordUnion(_.map(obj.parents, function(id) {
            return mapS.data[id];
          }));
          if (outline != null) {
            mapS.leafletMap.fitBounds(outline);
          }
          mapS.highlightObject(obj);
        } else {
          // Has no geographic information, but display info.
          //openSidenav(obj);   //TODO: doesn't work...
        }
      }

      mapS.highlightObject = function(obj) {
        // Visually mark this object as selected.  Recurses to parent
        // objects, too.
        // TODO: highlight this object
        // ...
        switch (obj.type) {
          case 'building':
            var path = mapS.map.paths[obj.id];
            path.fillOpacity = BUILDING_HIGHLIGHT_FILL_OPACITY;
            path.weight = BUILDING_HIGHLIGHT_OUTLINE_WEIGHT;
            break;
        }
        if (obj.parents && obj.parents.length >= 1) {
          obj.parents.forEach(function (parent) {
            mapS.highlightObject(mapS.data[parent]);
          })
        }
      }

      mapS.searchQuerySelected = function(obj) {
        if (obj == null) return;
        console.log("xxx");
        if ('outline' in obj) mapS.zoomOnObject(obj);
        else                  openSidenav(obj);
      }

      return mapS;
    })

    angular.module('usefulAaltoMap')
    .service('utils', function() {
      var utils = {};

      utils.coordUnion = function(objs) {
        // Return array of union of all coordinates of objects
        var newcoords = [ ];
        for (var i=0 ; i<objs.length ; i++) {
          var obj = objs[i];
          if (obj.outline) {
            for (var j=0 ; j<obj.outline.length ; j++) {
              newcoords.push(obj.outline[j]);
            }
          } else if (obj.latlon) {
            newcoords.push(obj.latlon);
          }
        }
        if (newcoords.length > 0)
          return newcoords;
      }

      utils.get_lang = function(obj, name) {
        // Search (for example) obj.name_en, obj.name, obj.name_fi, etc for best
        // translation of an object.
        if (obj == null) return;
        if (name+"_"+LANG in obj)  return obj[name+"_"+LANG];
        if (name          in obj)  return obj[name];
        if (name+"_en"    in obj)  return obj[name+"_en"];
        if (name+"_fi"    in obj)  return obj[name+"_fi"];
        if (name+"_sv"    in obj)  return obj[name+"_sv"];
      }

      return utils;
    })

  </script>

  <div style="height:100%" ui-view="main"></div>
  <div ui-view></div>
  <div class="about">
    Unofficial | <a target="_blank" href="https://github.com/usefulaaltomapfi/usefulaaltomap/wiki">About</a>
  </div>
</body>
</html>
